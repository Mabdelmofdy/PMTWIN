<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - PMTwin</title>
    <script>
        // #region agent log
        (function() {
            const log = (msg, data) => {
                fetch('http://127.0.0.1:7243/ingest/d6558776-52b0-46c0-a3b7-9753941ef8dd', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: 'login/index.html:INIT',
                        message: msg,
                        data: data,
                        timestamp: Date.now(),
                        sessionId: 'debug-session',
                        runId: 'run1'
                    })
                }).catch(() => {});
            };
            log('Page initialization', {
                pathname: window.location.pathname,
                href: window.location.href,
                origin: window.location.origin
            });
        })();
        // #endregion
        
        // Set base path dynamically based on current location
        // This fixes path resolution when accessed via Vercel rewrites (/auth/login/ -> /POC/pages/auth/login/index.html)
        (function() {
            // #region agent log
            const log = (msg, data) => {
                fetch('http://127.0.0.1:7243/ingest/d6558776-52b0-46c0-a3b7-9753941ef8dd', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: 'login/index.html:BASE_TAG',
                        message: msg,
                        data: data,
                        timestamp: Date.now(),
                        sessionId: 'debug-session',
                        runId: 'run1',
                        hypothesisId: 'C'
                    })
                }).catch(() => {});
            };
            // #endregion
            
            const currentPath = window.location.pathname;
            let basePath;
            
            // If accessed via /auth/login/ or /login/, use the user-facing URL path
            // Vercel rewrites handle the /POC/ prefix transparently, so we should use the user-facing path
            if (currentPath.match(/^\/(auth\/)?login\/?$/)) {
                basePath = currentPath.endsWith('/') ? currentPath : currentPath + '/';
            } else if (currentPath.includes('/pages/auth/login')) {
                // Already in correct path structure - use current path as base
                basePath = currentPath.endsWith('/') ? currentPath : currentPath + '/';
            } else {
                // Default fallback - use current path
                basePath = currentPath.endsWith('/') ? currentPath : currentPath + '/';
            }
            
            // #region agent log
            log('Base tag calculation', { currentPath, basePath });
            // #endregion
            
            const base = document.createElement('base');
            base.href = basePath;
            document.head.insertBefore(base, document.head.firstChild);
            
            // #region agent log
            log('Base tag set', { baseHref: base.href, actualBase: document.querySelector('base')?.href });
            // #endregion
        })();
        
        // #region agent log
        (function() {
            const log = (msg, data, hypothesisId = 'A') => {
                const logEntry = {
                    location: 'login/index.html:RESOURCE_MONITOR',
                    message: msg,
                    data: data,
                    timestamp: Date.now(),
                    sessionId: 'debug-session',
                    runId: 'run1',
                    hypothesisId: hypothesisId
                };
                // Log to console as fallback (visible in Vercel)
                console.log('[DEBUG]', msg, data);
                // Send to log server
                fetch('http://127.0.0.1:7243/ingest/d6558776-52b0-46c0-a3b7-9753941ef8dd', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(logEntry)
                }).catch(() => {});
            };
            
            // Monitor all resource loading
            const checkResource = (url, type) => {
                // Try HEAD first
                fetch(url, { method: 'HEAD' }).then(res => {
                    const contentType = res.headers.get('Content-Type');
                    log(`${type} resource response`, {
                        url: url,
                        status: res.status,
                        statusText: res.statusText,
                        contentType: contentType,
                        contentLength: res.headers.get('Content-Length'),
                        allHeaders: Object.fromEntries(res.headers.entries())
                    }, res.status === 404 ? 'A' : (contentType && contentType.includes('text/plain')) ? 'B' : 'D');
                }).catch(err => {
                    // If HEAD fails, try GET
                    fetch(url, { method: 'GET' }).then(res => {
                        const contentType = res.headers.get('Content-Type');
                        log(`${type} resource response (GET)`, {
                            url: url,
                            status: res.status,
                            statusText: res.statusText,
                            contentType: contentType,
                            contentLength: res.headers.get('Content-Length')
                        }, res.status === 404 ? 'A' : (contentType && contentType.includes('text/plain')) ? 'B' : 'D');
                    }).catch(err2 => {
                        log(`${type} resource check failed`, {
                            url: url,
                            headError: err.message,
                            getError: err2.message,
                            errorType: err2.name
                        }, 'A');
                    });
                });
            };
            
            // Monitor existing resources immediately
            const monitorExistingResources = () => {
                const links = document.querySelectorAll('link[rel="stylesheet"]');
                const scripts = document.querySelectorAll('script[src]');
                
                links.forEach(link => {
                    const href = link.href || link.getAttribute('href');
                    const resolvedHref = link.href;
                    log('CSS link detected', {
                        originalHref: href,
                        resolvedHref: resolvedHref,
                        baseHref: document.querySelector('base')?.href
                    }, 'C');
                    
                    checkResource(resolvedHref, 'CSS');
                    
                    link.addEventListener('error', function(e) {
                        log('CSS load error event', {
                            href: resolvedHref,
                            error: e.message || 'Load failed',
                            errorType: e.type,
                            target: e.target?.href,
                            currentTarget: e.currentTarget?.href
                        }, 'A');
                    });
                    
                    // Also check for MIME type errors
                    const originalSheet = link.sheet;
                    setTimeout(() => {
                        if (!link.sheet && !link.href.includes('data:')) {
                            log('CSS failed to load (no stylesheet)', {
                                href: resolvedHref,
                                sheet: link.sheet,
                                disabled: link.disabled
                            }, 'B');
                        }
                    }, 1000);
                });
                
                scripts.forEach(script => {
                    const src = script.src || script.getAttribute('src');
                    const resolvedSrc = script.src;
                    log('Script tag detected', {
                        originalSrc: src,
                        resolvedSrc: resolvedSrc,
                        baseHref: document.querySelector('base')?.href
                    }, 'C');
                    
                    checkResource(resolvedSrc, 'JS');
                    
                    script.addEventListener('error', function(e) {
                        log('Script load error event', {
                            src: resolvedSrc,
                            error: e.message || 'Load failed',
                            errorType: e.type,
                            target: e.target?.src,
                            currentTarget: e.currentTarget?.src
                        }, 'A');
                    });
                    
                    // Monitor script execution
                    const checkScriptLoaded = setInterval(() => {
                        if (script.readyState === 'complete' || script.readyState === 'loaded') {
                            clearInterval(checkScriptLoaded);
                            if (script.textContent === '' && !script.src.includes('data:')) {
                                log('Script may have failed to execute', {
                                    src: resolvedSrc,
                                    readyState: script.readyState,
                                    hasContent: script.textContent.length > 0
                                }, 'B');
                            }
                        }
                    }, 100);
                    setTimeout(() => clearInterval(checkScriptLoaded), 5000);
                });
            };
            
            // Monitor dynamically added resources
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) {
                            if (node.tagName === 'LINK' && node.rel === 'stylesheet') {
                                const href = node.href || node.getAttribute('href');
                                log('Dynamic CSS link added', {
                                    href: href,
                                    resolvedHref: node.href
                                }, 'C');
                                checkResource(node.href, 'CSS');
                            } else if (node.tagName === 'SCRIPT' && node.src) {
                                const src = node.src || node.getAttribute('src');
                                log('Dynamic script added', {
                                    src: src,
                                    resolvedSrc: node.src
                                }, 'C');
                                checkResource(node.src, 'JS');
                            }
                        }
                    });
                });
            });
            
            // Start monitoring
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    monitorExistingResources();
                    observer.observe(document.head, { childList: true, subtree: true });
                    observer.observe(document.body, { childList: true, subtree: true });
                });
            } else {
                monitorExistingResources();
                observer.observe(document.head, { childList: true, subtree: true });
                observer.observe(document.body, { childList: true, subtree: true });
            }
        })();
        // #endregion
    </script>
    <link rel="stylesheet" href="/POC/assets/css/main.css">
</head>
<body class="login-page">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="../../home/" class="navbar-brand">PMTwin</a>
                <button class="navbar-toggle" id="navbarToggle" aria-label="Toggle navigation"><i class="ph ph-list"></i></button>
                <ul class="navbar-nav" id="navbarNav">
                    <li><a href="../../home/" class="navbar-link">Home</a></li>
                    <li><a href="../../discovery/" class="navbar-link">Discover Projects</a></li>
                    <li><a href="../../wizard/" class="navbar-link">PMTwin Wizard</a></li>
                    <li><a href="../../knowledge/" class="navbar-link">Knowledge Hub</a></li>
                    <li><a href="../../service-providers/" class="navbar-link">Service Providers Directory</a></li>
                    <li><a href="../signup/" class="navbar-link">Sign Up</a></li>
                    <li><a href="./" class="navbar-link active">Login</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <div style="display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 80px); width: 100%;">
            <div style="width: 100%; max-width: 450px; padding: var(--spacing-4);">
                <h1 style="margin-bottom: var(--spacing-6); text-align: center;">
                    Login
                    <button 
                        class="demo-info-button" 
                        id="demoCredentialsBtn"
                        type="button"
                        title="View demo user credentials"
                        aria-label="View demo user credentials"
                    >!</button>
                </h1>
                <div class="card">
                    <div class="card-body">
                        <form id="loginForm">
                            <div class="form-group">
                                <label for="loginEmail" class="form-label">Email</label>
                                <input type="email" id="loginEmail" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="loginPassword" class="form-label">Password</label>
                                <input type="password" id="loginPassword" class="form-control" required>
                            </div>
                            <div id="loginError" class="alert alert-error" style="display: none;"></div>
                            <button type="submit" class="btn btn-primary btn-block">Login</button>
                        </form>
                        <p style="text-align: center; margin-top: var(--spacing-4);">
                            Don't have an account? <a href="../signup/">Sign up here</a>
                        </p>
                        <p style="text-align: center; margin-top: var(--spacing-2);">
                            <a href="../../home/">Back to Home</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer id="publicFooter" style="background: var(--bg-dark); color: var(--text-inverse); margin-top: var(--spacing-16);">
        <!-- Footer content will be loaded dynamically -->
    </footer>

    <!-- Configuration (must load first) -->
    <script src="/POC/src/config/config.js"></script>
    
    <!-- API Layer (for future Java backend integration) -->
    <script src="/POC/src/core/api/api-client.js"></script>
    <script src="/POC/src/core/api/api-service.js"></script>
    
    <!-- Core Scripts -->
    <script src="/POC/src/core/data/golden-seed-data.js"></script>
    <script src="/POC/src/core/data/data.js"></script>
    <script src="/POC/src/core/auth/user-manager.js"></script>
    <script src="/POC/src/core/auth/auth.js"></script>
    <script src="/POC/src/core/auth/auth-check.js"></script>
    <script src="/POC/src/utils/demo-credentials.js"></script>
    <script src="/POC/src/utils/check-user-roles.js"></script>
    <script src="/POC/src/services/services-loader.js"></script>
    <script src="/POC/data/data-loader.js"></script>
    
    <!-- Footer Component -->
    <script src="/POC/src/components/footer.js"></script>
    
    <!-- Component Scripts -->
    <script src="/POC/features/auth/login.js"></script>
    
    <!-- Initialize Component -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check for redirect after login
            const redirect = AuthCheck ? AuthCheck.getLoginRedirect() : null;
            
            if (window.auth && window.auth.login) {
                window.auth.login.init({ redirect: redirect });
            }
        });
    </script>
</body>
</html>

