<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Very permissive CSP for local development - MUST be first to prevent CSP errors -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; connect-src * 'unsafe-inline' 'unsafe-eval' ws: wss: http://127.0.0.1:* http://localhost:*; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; font-src * data:; img-src * data: blob:; frame-src *; object-src *; media-src *;">
    <title>Create Opportunity - PMTwin</title>
    <link rel="stylesheet" href="../../../assets/css/main.css">
    <script>
        // CRITICAL: Set CSP via meta tag immediately to prevent browser default CSP
        (function() {
            // Remove any existing CSP meta tags
            const existingCSP = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            if (existingCSP) {
                existingCSP.remove();
            }
            
            // Create new permissive CSP meta tag
            const cspMeta = document.createElement('meta');
            cspMeta.setAttribute('http-equiv', 'Content-Security-Policy');
            cspMeta.setAttribute('content', "default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; connect-src * 'unsafe-inline' 'unsafe-eval' ws: wss: http://127.0.0.1:* http://localhost:*; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline'; font-src * data:; img-src * data: blob:; frame-src *;");
            document.head.insertBefore(cspMeta, document.head.firstChild);
        })();
    </script>
</head>
<body>
    <!-- Main Content - Sidebar and Navbar are automatically added by layout system -->
    <main class="page-wrapper">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-header-content">
                    <div>
                        <h1>Create Opportunity</h1>
                        <p>Create a new opportunity for collaboration or service exchange</p>
                    </div>
                </div>
            </div>
            
            <!-- Wizard Container -->
            <div class="content-section">
                <div class="card enhanced-card">
                    <div class="card-body">
                        <div id="opportunityWizardContainer">
                            <!-- Wizard will be rendered here by opportunity-create.js -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Configuration (must load first) -->
    <script src="../../../src/config/config.js"></script>
    <script src="../../../src/core/config/location.config.js"></script>
    
    <!-- Unified Storage Adapter (must load before data.js) -->
    <script src="../../../src/core/storage/storage-adapter.js"></script>
    
    <!-- API Layer (for future Java backend integration) -->
    <script src="../../../src/core/api/api-client.js"></script>
    <script src="../../../src/core/api/api-service.js"></script>
    
    <!-- Core Scripts -->
    <script src="../../../src/core/data/golden-seed-data.js"></script>
    <script src="../../../src/core/data/data.js"></script>
    <script src="../../../src/core/auth/user-manager.js"></script>
    <script src="../../../src/core/auth/auth.js"></script>
    <script src="../../../src/core/auth/auth-check.js"></script>
    <script src="../../../src/utils/demo-credentials.js"></script>
    <script src="../../../src/services/services-loader.js"></script>
    <script src="../../../data/data-loader.js"></script>
    
    <!-- Opportunity Store (NEW) -->
    <script src="../../../assets/js/data/opportunityStore.js"></script>
    
    <!-- URL Helper -->
    <script src="../../../assets/js/utils/url.js"></script>
    
    <!-- Navigation Routes (must load before navigation.js) -->
    <script src="../../../src/core/routes/nav-routes.js"></script>
    
    <!-- Layout System (automatically includes sidebar and navbar) -->
    <script src="../../../src/core/layout/layout.js"></script>
    <script src="../../../src/core/layout/navigation.js"></script>
    <script src="../../../src/core/init/app-init.js"></script>
    
    <!-- Business Logic (for collaboration models) -->
    <script src="../../../src/business-logic/models/collaboration-model-definitions.js"></script>
    <script src="../../../src/business-logic/models/collaboration-models.js"></script>
    <script src="../../../src/business-logic/collab-init.js"></script>
    
    <!-- Payment Engines -->
    <script src="../../../src/business-logic/payment/barter-settlement.js"></script>
    <script src="../../../src/business-logic/payment/hybrid-payment.js"></script>
    <script src="../../../src/business-logic/payment/equity-payment.js"></script>
    <script src="../../../src/business-logic/payment/profit-sharing-payment.js"></script>
    
    <!-- Matching & Reputation -->
    <script src="../../../src/business-logic/reputation/reputation-service.js"></script>
    <script src="../../../src/core/matching/semantic-mirroring.js"></script>
    <script src="../../../src/business-logic/matching/matching-models.js"></script>
    <script src="../../../src/core/matching/matching-model-router.js"></script>
    
    <!-- Services -->
    <script src="../../../src/services/opportunities/deal-linking-service.js"></script>
    <script src="../../../src/services/barter/offer-register-service.js"></script>
    
    <!-- RABC -->
    <script src="../../../src/business-logic/rbac/rabc-service.js"></script>
    
    <!-- Collaboration Model Components -->
    <script src="../../../features/projects/collaboration-models-selector.js"></script>
    <script src="../../../features/projects/collaboration-model-fields.js"></script>
    
    <!-- Component Scripts -->
    <script src="../../../features/opportunities/opportunity-create.js"></script>
    
    <!-- Initialize Component -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            const isAuth = await AuthCheck.checkAuth({ requireAuth: true });
            if (!isAuth) return;
            
            // Check if editing existing opportunity (from query parameter)
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            
            // Initialize opportunity create wizard
            // Note: Sidebar and navbar are automatically initialized by app-init.js
            if (window.opportunityCreate) {
                window.opportunityCreate.init();
                
                // If editing, load the opportunity data
                if (editId) {
                    // TODO: Load opportunity data for editing
                    console.log('Edit mode for opportunity:', editId);
                }
            } else {
                console.error('opportunityCreate component not found');
            }
        });
    </script>
</body>
</html>
