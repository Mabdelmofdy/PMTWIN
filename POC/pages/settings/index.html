<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - PMTwin</title>
    <link rel="stylesheet" href="../../assets/css/main.css">
    <style>
        .settings-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        .settings-container h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2rem;
        }
        
        .settings-tabs {
            display: flex;
            gap: 0.25rem;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2.5rem;
            overflow-x: auto;
            flex-wrap: wrap;
            padding-bottom: 0.5rem;
        }
        
        .settings-tab {
            padding: 0.875rem 1.75rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            position: relative;
            border-radius: 6px 6px 0 0;
        }
        
        .settings-tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }
        
        .settings-tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            font-weight: 600;
            background: var(--bg-secondary);
        }
        
        .settings-panel {
            display: none !important;
        }
        
        .settings-panel.active {
            display: block !important;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .settings-panel .card {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .settings-panel .card-body {
            padding: 2rem;
        }
        
        .settings-section {
            margin-bottom: 3rem;
        }
        
        .settings-section:last-child {
            margin-bottom: 0;
        }
        
        .settings-section h3 {
            margin-bottom: 1.25rem;
            color: var(--text-primary);
            font-size: 1.35rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .settings-section p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .theme-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-top: 1.5rem;
        }
        
        .theme-option {
            flex: 1;
            padding: 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
        }
        
        .theme-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--color-primary);
            transform: scaleX(0);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .theme-option:hover {
            border-color: var(--color-primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        .theme-option:hover::before {
            transform: scaleX(1);
        }
        
        .theme-option.active {
            border-color: var(--color-primary);
            background: var(--bg-secondary);
            box-shadow: 0 4px 16px rgba(0, 102, 204, 0.15);
        }
        
        .theme-option.active::before {
            transform: scaleX(1);
        }
        
        .theme-option strong {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 0.75rem;
            color: var(--text-primary);
        }
        
        .theme-preview-box {
            width: 100%;
            height: 80px;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .theme-light .theme-preview-box {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #e9ecef 100%);
        }
        
        .theme-dark .theme-preview-box {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #404040 100%);
        }
        
        .theme-auto .theme-preview-box {
            background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 25%, #808080 50%, #404040 75%, #1a1a1a 100%);
        }
        
        .color-scheme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1.25rem;
            margin-top: 1.5rem;
            max-width: 600px;
        }
        
        .color-scheme-option {
            aspect-ratio: 1;
            border-radius: 12px;
            cursor: pointer;
            border: 4px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .color-scheme-option::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 8px;
            padding: 2px;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .color-scheme-option:hover {
            transform: scale(1.08) translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .color-scheme-option:hover::before {
            opacity: 1;
        }
        
        .color-scheme-option.active {
            border-color: var(--text-primary);
            box-shadow: 0 0 0 3px var(--color-primary), 0 4px 16px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }
        
        .color-scheme-option::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            color: white;
            font-size: 1.75rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .color-scheme-option.active::after {
            transform: translate(-50%, -50%) scale(1);
        }
        
        .timezone-select,
        .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        .timezone-select:focus,
        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }
        
        .format-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-top: 1rem;
        }
        
        .format-option {
            padding: 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-primary);
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .format-option:hover {
            border-color: var(--color-primary);
            background: var(--bg-secondary);
        }
        
        .format-option label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 0.75rem;
        }
        
        .format-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .preview-box {
            background: var(--bg-secondary);
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin-top: 0.75rem;
            font-family: var(--font-family-mono, 'Courier New', monospace);
            font-size: 0.95rem;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-group small {
            display: block;
            margin-top: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--bg-secondary);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-primary);
        }
        
        .save-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--color-success, #28a745);
            color: white;
            padding: 1rem 1.75rem;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            font-weight: 500;
        }
        
        .save-indicator.show {
            display: block;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100%) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 1rem;
            background: var(--bg-primary);
            transition: all 0.2s;
        }
        
        .session-item:hover {
            border-color: var(--color-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .session-info {
            flex: 1;
        }
        
        .session-info strong {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        .session-info small {
            color: var(--text-secondary);
            font-size: 0.875rem;
            display: block;
            line-height: 1.5;
        }
        
        hr {
            margin: 2.5rem 0;
            border: none;
            border-top: 1px solid var(--border-color);
        }
        
        .btn {
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        @media (max-width: 768px) {
            .settings-container {
                padding: 1rem 0.5rem;
            }
            
            .theme-preview {
                grid-template-columns: 1fr;
            }
            
            .color-scheme-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .format-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Main Content - Sidebar and Navbar are automatically added by layout system -->
    <main class="page-wrapper">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <div class="page-header-content">
                    <div>
                        <h1>Settings</h1>
                        <p>Customize your account preferences and application settings</p>
                    </div>
                </div>
            </div>

            <!-- Settings Tabs -->
            <div class="content-section">
                <div class="settings-tabs">
                <button class="settings-tab active" data-tab="notifications">Notifications</button>
                <button class="settings-tab" data-tab="privacy">Privacy</button>
                <button class="settings-tab" data-tab="account">Account & Security</button>
                <button class="settings-tab" data-tab="theme">Theme & Appearance</button>
                <button class="settings-tab" data-tab="time">Time & Date</button>
                <button class="settings-tab" data-tab="display">Display</button>
                <button class="settings-tab" data-tab="portal">Portal Preferences</button>
            </div>

            <!-- Settings Content -->
            <div id="settingsContent">
                <!-- Theme & Appearance Panel -->
                <div class="settings-panel" id="panel-theme">
                    <div class="card">
                        <div class="settings-section">
                            <h3>Theme Mode</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Choose your preferred color theme</p>
                            <div class="theme-preview">
                                <div class="theme-option theme-light active" data-theme="light">
                                    <div class="theme-preview-box"></div>
                                    <strong>Light</strong>
                                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem; margin-bottom: 0;">Bright and clean interface</p>
                                </div>
                                <div class="theme-option theme-dark" data-theme="dark">
                                    <div class="theme-preview-box"></div>
                                    <strong>Dark</strong>
                                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem; margin-bottom: 0;">Easy on the eyes</p>
                                </div>
                                <div class="theme-option theme-auto" data-theme="auto">
                                    <div class="theme-preview-box"></div>
                                    <strong>Auto</strong>
                                    <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem; margin-bottom: 0;">Follow system preference</p>
                                </div>
                            </div>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="settings-section">
                            <h3>Color Scheme</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Choose your preferred color palette</p>
                            <div class="color-scheme-grid">
                                <div class="color-scheme-option active" data-scheme="blue" style="background: linear-gradient(135deg, #0066CC 0%, #0052A3 100%);" title="Blue"></div>
                                <div class="color-scheme-option" data-scheme="green" style="background: linear-gradient(135deg, #00AA44 0%, #008833 100%);" title="Green"></div>
                                <div class="color-scheme-option" data-scheme="purple" style="background: linear-gradient(135deg, #7B68EE 0%, #5B4FC8 100%);" title="Purple"></div>
                                <div class="color-scheme-option" data-scheme="red" style="background: linear-gradient(135deg, #DC3545 0%, #C82333 100%);" title="Red"></div>
                                <div class="color-scheme-option" data-scheme="orange" style="background: linear-gradient(135deg, #FF6600 0%, #CC5200 100%);" title="Orange"></div>
                                <div class="color-scheme-option" data-scheme="teal" style="background: linear-gradient(135deg, #20C997 0%, #1AA179 100%);" title="Teal"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Time & Date Panel -->
                <div class="settings-panel" id="panel-time">
                    <div class="card">
                        <div class="settings-section">
                            <h3>Timezone</h3>
                            <div class="form-group">
                                <label for="timezone">Select your timezone</label>
                                <select id="timezone" class="timezone-select">
                                    <option value="UTC">UTC (Coordinated Universal Time)</option>
                                    <option value="America/New_York">America/New_York (EST/EDT)</option>
                                    <option value="America/Chicago">America/Chicago (CST/CDT)</option>
                                    <option value="America/Denver">America/Denver (MST/MDT)</option>
                                    <option value="America/Los_Angeles">America/Los_Angeles (PST/PDT)</option>
                                    <option value="Europe/London">Europe/London (GMT/BST)</option>
                                    <option value="Europe/Paris">Europe/Paris (CET/CEST)</option>
                                    <option value="Asia/Dubai">Asia/Dubai (GST)</option>
                                    <option value="Asia/Riyadh">Asia/Riyadh (AST)</option>
                                    <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
                                    <option value="Asia/Shanghai">Asia/Shanghai (CST)</option>
                                    <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                                    <option value="Australia/Sydney">Australia/Sydney (AEDT/AEST)</option>
                                </select>
                            </div>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="settings-section">
                            <h3>Date Format</h3>
                            <div class="format-options">
                                <div class="format-option">
                                    <label>
                                        <input type="radio" name="dateFormat" value="MM/DD/YYYY" checked>
                                        <span>MM/DD/YYYY</span>
                                    </label>
                                    <div class="preview-box" id="datePreview1">12/31/2024</div>
                                </div>
                                <div class="format-option">
                                    <label>
                                        <input type="radio" name="dateFormat" value="DD/MM/YYYY">
                                        <span>DD/MM/YYYY</span>
                                    </label>
                                    <div class="preview-box" id="datePreview2">31/12/2024</div>
                                </div>
                                <div class="format-option">
                                    <label>
                                        <input type="radio" name="dateFormat" value="YYYY-MM-DD">
                                        <span>YYYY-MM-DD</span>
                                    </label>
                                    <div class="preview-box" id="datePreview3">2024-12-31</div>
                                </div>
                                <div class="format-option">
                                    <label>
                                        <input type="radio" name="dateFormat" value="DD MMM YYYY">
                                        <span>DD MMM YYYY</span>
                                    </label>
                                    <div class="preview-box" id="datePreview4">31 Dec 2024</div>
                                </div>
                            </div>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="settings-section">
                            <h3>Time Format</h3>
                            <div class="format-options">
                                <div class="format-option">
                                    <label>
                                        <input type="radio" name="timeFormat" value="12h" checked>
                                        <span>12-hour (AM/PM)</span>
                                    </label>
                                    <div class="preview-box" id="timePreview1">02:30 PM</div>
                                </div>
                                <div class="format-option">
                                    <label>
                                        <input type="radio" name="timeFormat" value="24h">
                                        <span>24-hour</span>
                                    </label>
                                    <div class="preview-box" id="timePreview2">14:30</div>
                                </div>
                            </div>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="settings-section">
                            <h3>Current Time Preview</h3>
                            <div class="preview-box" style="font-size: 1.25rem; text-align: center; padding: 1.5rem;" id="currentTimePreview">
                                Loading...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Display Panel -->
                <div class="settings-panel" id="panel-display">
                    <div class="card">
                        <div class="settings-section">
                            <h3>Font Size</h3>
                            <div class="form-group">
                                <label for="fontSize">Adjust text size</label>
                                <input type="range" id="fontSize" min="0" max="2" step="0.25" value="0" style="width: 100%;">
                                <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                                    <span>Small</span>
                                    <span>Default</span>
                                    <span>Large</span>
                                    <span>Extra Large</span>
                                </div>
                            </div>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="settings-section">
                            <h3>Display Density</h3>
                            <div class="format-options">
                                <div class="format-option">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="density" value="compact" checked>
                                        <span>Compact</span>
                                    </label>
                                    <small style="color: var(--text-secondary);">More content per screen</small>
                                </div>
                                <div class="format-option">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="density" value="comfortable">
                                        <span>Comfortable</span>
                                    </label>
                                    <small style="color: var(--text-secondary);">Balanced spacing</small>
                                </div>
                                <div class="format-option">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="radio" name="density" value="spacious">
                                        <span>Spacious</span>
                                    </label>
                                    <small style="color: var(--text-secondary);">More breathing room</small>
                                </div>
                            </div>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="settings-section">
                            <h3>Language</h3>
                            <div class="form-group">
                                <label for="language">Select language</label>
                                <select id="language" class="timezone-select">
                                    <option value="en">English</option>
                                    <option value="ar">العربية (Arabic)</option>
                                    <option value="fr">Français (French)</option>
                                    <option value="es">Español (Spanish)</option>
                                    <option value="de">Deutsch (German)</option>
                                    <option value="zh">中文 (Chinese)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Panel -->
                <div class="settings-panel active" id="panel-notifications">
                    <div class="card">
                        <div class="settings-section">
                            <h3>Email Notifications</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Choose which email notifications you want to receive</p>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="emailNotifications" checked style="width: auto;">
                                    <span>Enable email notifications</span>
                                </label>
                                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                    Receive email notifications for important account activities
                                </small>
                            </div>
                            
                            <div style="padding-left: 1.5rem; border-left: 2px solid var(--border-color);">
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="emailMatches" checked style="width: auto;">
                                        <span>New matches</span>
                                    </label>
                                    <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem; margin-left: 1.75rem;">
                                        Get notified when you receive new project matches
                                    </small>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="emailProposals" checked style="width: auto;">
                                        <span>Proposal updates</span>
                                    </label>
                                    <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem; margin-left: 1.75rem;">
                                        Receive updates on proposal status changes
                                    </small>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="emailProjects" checked style="width: auto;">
                                        <span>Project notifications</span>
                                    </label>
                                    <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem; margin-left: 1.75rem;">
                                        Updates on projects you're involved in
                                    </small>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="emailCollaborations" checked style="width: auto;">
                                        <span>Collaboration opportunities</span>
                                    </label>
                                    <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem; margin-left: 1.75rem;">
                                        New collaboration opportunities and applications
                                    </small>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="emailMessages" checked style="width: auto;">
                                        <span>Messages and communications</span>
                                    </label>
                                    <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem; margin-left: 1.75rem;">
                                        Direct messages and communication updates
                                    </small>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="emailSystem" checked style="width: auto;">
                                        <span>System notifications</span>
                                    </label>
                                    <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem; margin-left: 1.75rem;">
                                        Important system updates and announcements
                                    </small>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 2rem; margin-bottom: 1.5rem;">
                                <label for="emailFrequency" class="form-label">Email Frequency</label>
                                <select id="emailFrequency" class="form-control">
                                    <option value="immediate">Immediate (as they happen)</option>
                                    <option value="daily">Daily digest</option>
                                    <option value="weekly">Weekly digest</option>
                                </select>
                                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                    Choose how often you receive email notifications
                                </small>
                            </div>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="settings-section">
                            <h3>In-App Notifications</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Control how you receive notifications within the application</p>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="inAppNotifications" checked style="width: auto;">
                                    <span>Enable in-app notifications</span>
                                </label>
                                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                    Show notification badges and alerts within the portal
                                </small>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="browserNotifications" style="width: auto;">
                                    <span>Browser push notifications</span>
                                </label>
                                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                    Receive browser notifications even when the portal is closed
                                </small>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label for="notificationSound" class="form-label">Notification Sound</label>
                                <select id="notificationSound" class="form-control">
                                    <option value="none">None</option>
                                    <option value="default">Default</option>
                                    <option value="gentle">Gentle</option>
                                    <option value="chime">Chime</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Privacy Panel -->
                <div class="settings-panel" id="panel-privacy">
                    <div class="card">
                        <div class="settings-section">
                            <h3>Profile Visibility</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Control who can see your profile information</p>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label for="profileVisibility" class="form-label">Profile Visibility</label>
                                <select id="profileVisibility" class="form-control">
                                    <option value="public">Public (Everyone can see)</option>
                                    <option value="registered">Registered Users Only</option>
                                    <option value="matched">Matched Users Only</option>
                                    <option value="private">Private (Only you)</option>
                                </select>
                                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                    Choose who can view your profile
                                </small>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="showEmail" checked style="width: auto;">
                                    <span>Show email address on profile</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="showPhone" style="width: auto;">
                                    <span>Show phone number on profile</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="showLocation" checked style="width: auto;">
                                    <span>Show location on profile</span>
                                </label>
                            </div>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="settings-section">
                            <h3>Data & Privacy</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Manage your data and privacy preferences</p>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="analyticsTracking" checked style="width: auto;">
                                    <span>Allow analytics tracking</span>
                                </label>
                                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                    Help us improve by sharing anonymous usage data
                                </small>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="allowSearch" checked style="width: auto;">
                                    <span>Allow profile to appear in search results</span>
                                </label>
                                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                    Let other users find you through search
                                </small>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="showActivityStatus" checked style="width: auto;">
                                    <span>Show activity status</span>
                                </label>
                                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                    Let others see when you're online
                                </small>
                            </div>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="settings-section">
                            <h3>Data Management</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Manage your account data</p>
                            
                            <div style="display: grid; gap: 1rem;">
                                <button id="exportDataBtn" class="btn btn-outline" style="text-align: left; justify-content: flex-start;">
                                    <i class="ph ph-download"></i> Export My Data
                                </button>
                                <button id="deleteAccountBtn" class="btn btn-danger" style="text-align: left; justify-content: flex-start;">
                                    <i class="ph ph-trash"></i> Delete Account
                                </button>
                            </div>
                            <small style="color: var(--text-secondary); display: block; margin-top: 1rem;">
                                Export your data or permanently delete your account. Account deletion cannot be undone.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Account & Security Panel -->
                <div class="settings-panel" id="panel-account">
                    <div class="card">
                        <div class="settings-section">
                            <h3>Change Password</h3>
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label for="currentPassword">Current Password</label>
                                <input type="password" id="currentPassword" class="form-control" placeholder="Enter current password">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
                                <small style="color: var(--text-secondary);">Password must be at least 8 characters long</small>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password">
                            </div>
                            
                            <button id="changePasswordBtn" class="btn btn-primary">Change Password</button>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="settings-section">
                            <h3>Security</h3>
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="twoFactorAuth" style="width: auto;">
                                    <span>Enable Two-Factor Authentication</span>
                                </label>
                                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                    Add an extra layer of security to your account
                                </small>
                            </div>
                            
                            <button id="saveSecurityBtn" class="btn btn-primary">Save Security Settings</button>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="settings-section">
                            <h3>Active Sessions</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Manage your active sessions across different devices
                            </p>
                            <div id="activeSessions" style="margin-bottom: 1rem;">
                                <!-- Test Data: Active Sessions -->
                                <div class="session-item" style="border-left: 3px solid var(--success-color); margin-bottom: 0.75rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div class="session-info" style="flex: 1;">
                                        <strong style="display: block; margin-bottom: 0.25rem;">Desktop</strong>
                                        <small style="color: var(--text-secondary);">Chrome • Current Location</small>
                                        <small style="display: block; margin-top: 0.25rem; color: var(--text-secondary);">
                                            Last active: Now • IP: 192.168.1.100
                                        </small>
                                    </div>
                                    <span class="badge" style="background: var(--success-color); color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">Current Session</span>
                                </div>
                                
                                <div class="session-item" style="opacity: 0.85; margin-bottom: 0.75rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div class="session-info" style="flex: 1;">
                                        <strong style="display: block; margin-bottom: 0.25rem;">iPhone 14 Pro</strong>
                                        <small style="color: var(--text-secondary);">Safari • Riyadh, Saudi Arabia</small>
                                        <small style="display: block; margin-top: 0.25rem; color: var(--text-secondary);">
                                            Last active: 2 hours ago • IP: 185.123.45.67
                                        </small>
                                    </div>
                                    <button onclick="revokeSession(0)" class="btn btn-sm" style="padding: 0.25rem 0.75rem; font-size: 0.75rem; background: var(--color-danger, #dc3545); color: white; border: none; border-radius: 4px; cursor: pointer;">Revoke</button>
                                </div>
                                
                                <div class="session-item" style="opacity: 0.85; margin-bottom: 0.75rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div class="session-info" style="flex: 1;">
                                        <strong style="display: block; margin-bottom: 0.25rem;">Windows PC</strong>
                                        <small style="color: var(--text-secondary);">Chrome • Dubai, UAE</small>
                                        <small style="display: block; margin-top: 0.25rem; color: var(--text-secondary);">
                                            Last active: 1 day ago • IP: 203.0.113.42
                                        </small>
                                    </div>
                                    <button onclick="revokeSession(1)" class="btn btn-sm" style="padding: 0.25rem 0.75rem; font-size: 0.75rem; background: var(--color-danger, #dc3545); color: white; border: none; border-radius: 4px; cursor: pointer;">Revoke</button>
                                </div>
                                
                                <div class="session-item" style="opacity: 0.85; margin-bottom: 0.75rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div class="session-info" style="flex: 1;">
                                        <strong style="display: block; margin-bottom: 0.25rem;">iPad Pro</strong>
                                        <small style="color: var(--text-secondary);">Safari • Jeddah, Saudi Arabia</small>
                                        <small style="display: block; margin-top: 0.25rem; color: var(--text-secondary);">
                                            Last active: 3 days ago • IP: 198.51.100.10
                                        </small>
                                    </div>
                                    <button onclick="revokeSession(2)" class="btn btn-sm" style="padding: 0.25rem 0.75rem; font-size: 0.75rem; background: var(--color-danger, #dc3545); color: white; border: none; border-radius: 4px; cursor: pointer;">Revoke</button>
                                </div>
                            </div>
                            <button id="refreshSessionsBtn" class="btn btn-secondary">Refresh Sessions</button>
                        </div>
                    </div>
                </div>

                <!-- Portal Preferences Panel -->
                <div class="settings-panel" id="panel-portal">
                    <div class="card">
                        <div class="settings-section">
                            <h3>Dashboard Preferences</h3>
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="showWelcomeMessage" checked style="width: auto;">
                                    <span>Show welcome message on dashboard</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="showQuickActions" checked style="width: auto;">
                                    <span>Show quick action buttons</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="showRecentActivity" checked style="width: auto;">
                                    <span>Show recent activity feed</span>
                                </label>
                            </div>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="settings-section">
                            <h3>Navigation</h3>
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="sidebarCollapsed" style="width: auto;">
                                    <span>Start with sidebar collapsed</span>
                                </label>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="rememberSidebarState" checked style="width: auto;">
                                    <span>Remember sidebar state</span>
                                </label>
                            </div>
                        </div>

                        <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

                        <div class="settings-section">
                            <h3>Data & Privacy</h3>
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="autoSave" checked style="width: auto;">
                                    <span>Auto-save form data</span>
                                </label>
                                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                    Automatically save form progress as you type
                                </small>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="analyticsTracking" checked style="width: auto;">
                                    <span>Allow analytics tracking</span>
                                </label>
                                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                    Help us improve by sharing anonymous usage data
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Save Indicator -->
    <div class="save-indicator" id="saveIndicator">
        <strong>✓ Settings saved successfully!</strong>
    </div>

    <!-- Configuration (must load first) -->
    <script src="../../src/config/config.js"></script>
    
    <!-- API Layer (for future Java backend integration) -->
    <script src="../../src/core/api/api-client.js"></script>
    <script src="../../src/core/api/api-service.js"></script>
    
    <!-- Core Scripts -->
    <script src="../../src/core/data/data.js"></script>
    <script src="../../src/core/auth/auth.js"></script>
    <script src="../../src/core/auth/auth-check.js"></script>
    <script src="../../src/utils/demo-credentials.js"></script>
    <script src="../../src/services/services-loader.js"></script>
    <script src="../../data/data-loader.js"></script>
    
    <!-- Layout System (automatically includes sidebar and navbar) -->
    <script src="../../src/core/layout/layout.js"></script>
    <script src="../../src/core/layout/navigation.js"></script>
    <script src="../../src/core/init/app-init.js"></script>
    
    <!-- Settings Script -->
    <script>
        // Settings storage key
        const SETTINGS_KEY = 'pmtwin_user_settings';
        
        // Default settings
        const defaultSettings = {
            theme: 'light',
            colorScheme: 'blue',
            timezone: (() => {
                try {
                    return Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
                } catch (e) {
                    return 'UTC';
                }
            })(),
            dateFormat: 'MM/DD/YYYY',
            timeFormat: '12h',
            fontSize: 0,
            density: 'compact',
            language: 'en',
            emailNotifications: true,
            emailMatches: true,
            emailProposals: true,
            emailProjects: true,
            emailCollaborations: true,
            emailMessages: true,
            emailSystem: true,
            emailFrequency: 'immediate',
            inAppNotifications: true,
            browserNotifications: false,
            notificationSound: 'default',
            profileVisibility: 'registered',
            showEmail: true,
            showPhone: false,
            showLocation: true,
            allowSearch: true,
            showActivityStatus: true,
            twoFactorAuth: false,
            showWelcomeMessage: true,
            showQuickActions: true,
            showRecentActivity: true,
            sidebarCollapsed: false,
            rememberSidebarState: true,
            autoSave: true,
            analyticsTracking: true
        };
        
        // Initialize with test data if no settings exist
        function initializeTestData() {
            try {
                const stored = localStorage.getItem(SETTINGS_KEY);
                if (!stored) {
                    // Set some test values for demonstration
                    const testSettings = {
                        ...defaultSettings,
                        timezone: 'Asia/Riyadh', // Test timezone
                        dateFormat: 'DD/MM/YYYY', // Test date format
                        timeFormat: '24h', // Test time format
                        fontSize: 0.5, // Slightly larger font
                        density: 'comfortable',
                        language: 'en',
                        emailNotifications: true,
                        emailMatches: true,
                        emailProposals: false, // Test: some disabled
                        emailProjects: true,
                        inAppNotifications: true,
                        browserNotifications: true, // Test: enabled
                        twoFactorAuth: false,
                        showWelcomeMessage: true,
                        showQuickActions: true,
                        showRecentActivity: false, // Test: disabled
                        sidebarCollapsed: false,
                        rememberSidebarState: true,
                        autoSave: true,
                        analyticsTracking: true
                    };
                    localStorage.setItem(SETTINGS_KEY, JSON.stringify(testSettings));
                    console.log('[Settings] Test data initialized');
                }
            } catch (e) {
                console.error('Error initializing test data:', e);
            }
        }
        
        // Load settings from localStorage
        function loadSettings() {
            try {
                const stored = localStorage.getItem(SETTINGS_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    // Merge with defaults to ensure all settings exist (handles new settings added later)
                    return { ...defaultSettings, ...parsed };
                }
            } catch (e) {
                console.error('Error loading settings:', e);
            }
            return { ...defaultSettings };
        }
        
        // Save settings to localStorage
        function saveSettings(settings) {
            try {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
                showSaveIndicator();
                return true;
            } catch (e) {
                console.error('Error saving settings:', e);
                return false;
            }
        }
        
        // Get current settings
        function getSettings() {
            return loadSettings();
        }
        
        // Update settings
        function updateSettings(updates) {
            const current = getSettings();
            const updated = { ...current, ...updates };
            saveSettings(updated);
            applySettings(updated);
        }
        
        // Apply settings to the page
        function applySettings(settings) {
            try {
                // Apply theme
                document.body.className = document.body.className.replace(/theme-\w+/g, '');
                if (settings.theme === 'auto') {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    document.body.classList.add(prefersDark ? 'theme-dark' : 'theme-light');
                } else {
                    document.body.classList.add(`theme-${settings.theme || 'light'}`);
                }
                
                // Apply color scheme (update CSS variables)
                applyColorScheme(settings.colorScheme || 'blue');
                
                // Apply font size
                const fontSizeMap = { 
                    0: '1rem', 0.25: '1.05rem', 0.5: '1.1rem', 0.75: '1.15rem', 
                    1: '1.2rem', 1.25: '1.3rem', 1.5: '1.4rem', 1.75: '1.5rem', 2: '1.6rem' 
                };
                const fontSize = fontSizeMap[settings.fontSize] || '1rem';
                document.documentElement.style.setProperty('--font-size-base', fontSize);
                
                // Apply density (update spacing)
                applyDensity(settings.density || 'compact');
            } catch (error) {
                console.error('Error applying settings:', error);
            }
        }
        
        // Apply color scheme
        function applyColorScheme(scheme) {
            const colorSchemes = {
                blue: { primary: '#0066CC', primaryDark: '#0052A3', primaryLight: '#3385D6' },
                green: { primary: '#00AA44', primaryDark: '#008833', primaryLight: '#33BB66' },
                purple: { primary: '#7B68EE', primaryDark: '#5B4FC8', primaryLight: '#9B88FF' },
                red: { primary: '#DC3545', primaryDark: '#C82333', primaryLight: '#E85D6D' },
                orange: { primary: '#FF6600', primaryDark: '#CC5200', primaryLight: '#FF8533' },
                teal: { primary: '#20C997', primaryDark: '#1AA179', primaryLight: '#4DD4B0' }
            };
            
            const colors = colorSchemes[scheme] || colorSchemes.blue;
            document.documentElement.style.setProperty('--color-primary', colors.primary);
            document.documentElement.style.setProperty('--color-primary-dark', colors.primaryDark);
            document.documentElement.style.setProperty('--color-primary-light', colors.primaryLight);
            document.documentElement.style.setProperty('--text-link', colors.primary);
            document.documentElement.style.setProperty('--text-link-hover', colors.primaryDark);
        }
        
        // Apply display density
        function applyDensity(density) {
            const densityMap = {
                compact: { spacing: '0.5rem', padding: '0.75rem' },
                comfortable: { spacing: '1rem', padding: '1rem' },
                spacious: { spacing: '1.5rem', padding: '1.5rem' }
            };
            
            const densitySettings = densityMap[density] || densityMap.comfortable;
            // Apply density to specific elements if needed
            document.documentElement.style.setProperty('--density-spacing', densitySettings.spacing);
            document.documentElement.style.setProperty('--density-padding', densitySettings.padding);
        }
        
        // Show save indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            if (indicator) {
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 3000);
            }
        }
        
        // Listen for system theme changes when auto theme is selected
        function setupThemeListener() {
            const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            mediaQuery.addEventListener('change', (e) => {
                const settings = getSettings();
                if (settings.theme === 'auto') {
                    applySettings(settings);
                }
            });
        }
        
        // Initialize settings page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check authentication
                const isAuth = await AuthCheck.checkAuth({ requireAuth: true });
                if (!isAuth) {
                    window.location.href = '../login/';
                    return;
                }
                
                // Get current user
                let currentUser = null;
                if (typeof PMTwinData !== 'undefined' && PMTwinData.Sessions) {
                    currentUser = PMTwinData.Sessions.getCurrentUser();
                } else if (typeof PMTwinAuth !== 'undefined' && typeof PMTwinAuth.getCurrentUser === 'function') {
                    currentUser = PMTwinAuth.getCurrentUser();
                }
                
                if (!currentUser) {
                    console.error('No current user found');
                    const container = document.getElementById('settingsContent');
                    if (container) {
                        container.innerHTML = `
                            <div class="alert alert-error">
                                <p>No user session found. Please log in again.</p>
                                <a href="../auth/login/" class="btn btn-primary">Go to Login</a>
                            </div>
                        `;
                    }
                    return;
                }
                
                // Initialize test data if needed
                initializeTestData();
                
                // Load and apply settings
                const settings = getSettings();
                applySettings(settings);
                populateSettingsForm(settings);
                
                // Initialize UI
                initializeTabs();
                initializeSettingsHandlers();
                
                // Load active sessions after a short delay to ensure DOM is ready
                setTimeout(() => {
                    loadActiveSessions();
                }, 100);
                
                startTimePreview();
                setupThemeListener();
                
                // Debug: Verify all panels exist
                const panelIds = ['panel-notifications', 'panel-privacy', 'panel-account', 'panel-theme', 'panel-time', 'panel-display', 'panel-portal'];
                panelIds.forEach(panelId => {
                    const panel = document.getElementById(panelId);
                    if (!panel) {
                        console.error('Panel not found:', panelId);
                    } else {
                        console.log('Panel found:', panelId);
                    }
                });
            } catch (error) {
                console.error('Error initializing settings:', error);
            }
        });
        
        // Initialize tabs
        function initializeTabs() {
            const tabs = document.querySelectorAll('.settings-tab');
            if (tabs.length === 0) {
                console.error('No settings tabs found');
                return;
            }
            
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const tabName = tab.dataset.tab;
                    if (!tabName) {
                        console.error('Tab missing data-tab attribute:', tab);
                        return;
                    }
                    
                    console.log('Switching to tab:', tabName);
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update active panel
                    const panels = document.querySelectorAll('.settings-panel');
                    panels.forEach(panel => {
                        panel.classList.remove('active');
                    });
                    
                    const targetPanel = document.getElementById(`panel-${tabName}`);
                    if (targetPanel) {
                        targetPanel.classList.add('active');
                        console.log('Activated panel:', `panel-${tabName}`);
                    } else {
                        console.error('Panel not found:', `panel-${tabName}`);
                    }
                });
            });
            
            // Ensure first tab is active on load
            const firstTab = document.querySelector('.settings-tab.active');
            if (firstTab) {
                const firstTabName = firstTab.dataset.tab;
                const firstPanel = document.getElementById(`panel-${firstTabName}`);
                if (firstPanel) {
                    firstPanel.classList.add('active');
                }
            }
        }
        
        // Populate form with current settings
        function populateSettingsForm(settings) {
            try {
                // Theme
                const themeOption = document.querySelector(`.theme-option[data-theme="${settings.theme}"]`);
                if (themeOption) {
                    document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
                    themeOption.classList.add('active');
                }
                
                const colorSchemeOption = document.querySelector(`.color-scheme-option[data-scheme="${settings.colorScheme}"]`);
                if (colorSchemeOption) {
                    document.querySelectorAll('.color-scheme-option').forEach(o => o.classList.remove('active'));
                    colorSchemeOption.classList.add('active');
                }
                
                // Time
                const timezoneSelect = document.getElementById('timezone');
                if (timezoneSelect) {
                    // Check if timezone exists in options, otherwise use UTC
                    const timezoneOption = Array.from(timezoneSelect.options).find(opt => opt.value === settings.timezone);
                    timezoneSelect.value = timezoneOption ? settings.timezone : 'UTC';
                }
                
                const dateFormatRadio = document.querySelector(`input[name="dateFormat"][value="${settings.dateFormat}"]`);
                if (dateFormatRadio) {
                    dateFormatRadio.checked = true;
                }
                
                const timeFormatRadio = document.querySelector(`input[name="timeFormat"][value="${settings.timeFormat}"]`);
                if (timeFormatRadio) {
                    timeFormatRadio.checked = true;
                }
                
                // Display
                const fontSizeSlider = document.getElementById('fontSize');
                if (fontSizeSlider) {
                    fontSizeSlider.value = settings.fontSize || 0;
                }
                
                const densityRadio = document.querySelector(`input[name="density"][value="${settings.density}"]`);
                if (densityRadio) {
                    densityRadio.checked = true;
                }
                
                const languageSelect = document.getElementById('language');
                if (languageSelect) {
                    languageSelect.value = settings.language || 'en';
                }
                
                // Notifications
                const emailNotifications = document.getElementById('emailNotifications');
                if (emailNotifications) emailNotifications.checked = settings.emailNotifications !== false;
                
                const emailMatches = document.getElementById('emailMatches');
                if (emailMatches) emailMatches.checked = settings.emailMatches !== false;
                
                const emailProposals = document.getElementById('emailProposals');
                if (emailProposals) emailProposals.checked = settings.emailProposals !== false;
                
                const emailProjects = document.getElementById('emailProjects');
                if (emailProjects) emailProjects.checked = settings.emailProjects !== false;
                
                const inAppNotifications = document.getElementById('inAppNotifications');
                if (inAppNotifications) inAppNotifications.checked = settings.inAppNotifications !== false;
                
                const browserNotifications = document.getElementById('browserNotifications');
                if (browserNotifications) browserNotifications.checked = settings.browserNotifications === true;
                
                const emailCollaborations = document.getElementById('emailCollaborations');
                if (emailCollaborations) emailCollaborations.checked = settings.emailCollaborations !== false;
                
                const emailMessages = document.getElementById('emailMessages');
                if (emailMessages) emailMessages.checked = settings.emailMessages !== false;
                
                const emailSystem = document.getElementById('emailSystem');
                if (emailSystem) emailSystem.checked = settings.emailSystem !== false;
                
                const emailFrequency = document.getElementById('emailFrequency');
                if (emailFrequency) emailFrequency.value = settings.emailFrequency || 'immediate';
                
                const notificationSound = document.getElementById('notificationSound');
                if (notificationSound) notificationSound.value = settings.notificationSound || 'default';
                
                const profileVisibility = document.getElementById('profileVisibility');
                if (profileVisibility) profileVisibility.value = settings.profileVisibility || 'registered';
                
                const showEmail = document.getElementById('showEmail');
                if (showEmail) showEmail.checked = settings.showEmail !== false;
                
                const showPhone = document.getElementById('showPhone');
                if (showPhone) showPhone.checked = settings.showPhone === true;
                
                const showLocation = document.getElementById('showLocation');
                if (showLocation) showLocation.checked = settings.showLocation !== false;
                
                const allowSearch = document.getElementById('allowSearch');
                if (allowSearch) allowSearch.checked = settings.allowSearch !== false;
                
                const showActivityStatus = document.getElementById('showActivityStatus');
                if (showActivityStatus) showActivityStatus.checked = settings.showActivityStatus !== false;
                
                // Account
                const twoFactorAuth = document.getElementById('twoFactorAuth');
                if (twoFactorAuth) twoFactorAuth.checked = settings.twoFactorAuth === true;
                
                // Portal
                const showWelcomeMessage = document.getElementById('showWelcomeMessage');
                if (showWelcomeMessage) showWelcomeMessage.checked = settings.showWelcomeMessage !== false;
                
                const showQuickActions = document.getElementById('showQuickActions');
                if (showQuickActions) showQuickActions.checked = settings.showQuickActions !== false;
                
                const showRecentActivity = document.getElementById('showRecentActivity');
                if (showRecentActivity) showRecentActivity.checked = settings.showRecentActivity !== false;
                
                const sidebarCollapsed = document.getElementById('sidebarCollapsed');
                if (sidebarCollapsed) sidebarCollapsed.checked = settings.sidebarCollapsed === true;
                
                const rememberSidebarState = document.getElementById('rememberSidebarState');
                if (rememberSidebarState) rememberSidebarState.checked = settings.rememberSidebarState !== false;
                
                const autoSave = document.getElementById('autoSave');
                if (autoSave) autoSave.checked = settings.autoSave !== false;
                
                const analyticsTracking = document.getElementById('analyticsTracking');
                if (analyticsTracking) analyticsTracking.checked = settings.analyticsTracking !== false;
            } catch (error) {
                console.error('Error populating settings form:', error);
            }
        }
        
        // Initialize settings handlers
        function initializeSettingsHandlers() {
            try {
                // Theme handlers
                document.querySelectorAll('.theme-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
                        option.classList.add('active');
                        updateSettings({ theme: option.dataset.theme });
                    });
                });
                
                document.querySelectorAll('.color-scheme-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.color-scheme-option').forEach(o => o.classList.remove('active'));
                        option.classList.add('active');
                        updateSettings({ colorScheme: option.dataset.scheme });
                    });
                });
                
                // Time handlers
                const timezoneSelect = document.getElementById('timezone');
                if (timezoneSelect) {
                    timezoneSelect.addEventListener('change', (e) => {
                        updateSettings({ timezone: e.target.value });
                    });
                }
                
                document.querySelectorAll('input[name="dateFormat"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        updateSettings({ dateFormat: e.target.value });
                        // Restart time preview to show new format
                        startTimePreview();
                    });
                });
                
                document.querySelectorAll('input[name="timeFormat"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        updateSettings({ timeFormat: e.target.value });
                        // Restart time preview to show new format
                        startTimePreview();
                    });
                });
                
                // Display handlers
                const fontSizeSlider = document.getElementById('fontSize');
                if (fontSizeSlider) {
                    fontSizeSlider.addEventListener('input', (e) => {
                        updateSettings({ fontSize: parseFloat(e.target.value) });
                    });
                }
                
                document.querySelectorAll('input[name="density"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        updateSettings({ density: e.target.value });
                    });
                });
                
                const languageSelect = document.getElementById('language');
                if (languageSelect) {
                    languageSelect.addEventListener('change', (e) => {
                        updateSettings({ language: e.target.value });
                    });
                }
                
                // Notification handlers
                const emailNotifications = document.getElementById('emailNotifications');
                if (emailNotifications) {
                    emailNotifications.addEventListener('change', (e) => {
                        updateSettings({ emailNotifications: e.target.checked });
                    });
                }
                
                const emailMatches = document.getElementById('emailMatches');
                if (emailMatches) {
                    emailMatches.addEventListener('change', (e) => {
                        updateSettings({ emailMatches: e.target.checked });
                    });
                }
                
                const emailProposals = document.getElementById('emailProposals');
                if (emailProposals) {
                    emailProposals.addEventListener('change', (e) => {
                        updateSettings({ emailProposals: e.target.checked });
                    });
                }
                
                const emailProjects = document.getElementById('emailProjects');
                if (emailProjects) {
                    emailProjects.addEventListener('change', (e) => {
                        updateSettings({ emailProjects: e.target.checked });
                    });
                }
                
                const inAppNotifications = document.getElementById('inAppNotifications');
                if (inAppNotifications) {
                    inAppNotifications.addEventListener('change', (e) => {
                        updateSettings({ inAppNotifications: e.target.checked });
                    });
                }
                
                const browserNotifications = document.getElementById('browserNotifications');
                if (browserNotifications) {
                    browserNotifications.addEventListener('change', (e) => {
                        updateSettings({ browserNotifications: e.target.checked });
                    });
                }
                
                const emailCollaborations = document.getElementById('emailCollaborations');
                if (emailCollaborations) {
                    emailCollaborations.addEventListener('change', (e) => {
                        updateSettings({ emailCollaborations: e.target.checked });
                    });
                }
                
                const emailMessages = document.getElementById('emailMessages');
                if (emailMessages) {
                    emailMessages.addEventListener('change', (e) => {
                        updateSettings({ emailMessages: e.target.checked });
                    });
                }
                
                const emailSystem = document.getElementById('emailSystem');
                if (emailSystem) {
                    emailSystem.addEventListener('change', (e) => {
                        updateSettings({ emailSystem: e.target.checked });
                    });
                }
                
                const emailFrequency = document.getElementById('emailFrequency');
                if (emailFrequency) {
                    emailFrequency.addEventListener('change', (e) => {
                        updateSettings({ emailFrequency: e.target.value });
                    });
                }
                
                const notificationSound = document.getElementById('notificationSound');
                if (notificationSound) {
                    notificationSound.addEventListener('change', (e) => {
                        updateSettings({ notificationSound: e.target.value });
                    });
                }
                
                const profileVisibility = document.getElementById('profileVisibility');
                if (profileVisibility) {
                    profileVisibility.addEventListener('change', (e) => {
                        updateSettings({ profileVisibility: e.target.value });
                    });
                }
                
                const showEmail = document.getElementById('showEmail');
                if (showEmail) {
                    showEmail.addEventListener('change', (e) => {
                        updateSettings({ showEmail: e.target.checked });
                    });
                }
                
                const showPhone = document.getElementById('showPhone');
                if (showPhone) {
                    showPhone.addEventListener('change', (e) => {
                        updateSettings({ showPhone: e.target.checked });
                    });
                }
                
                const showLocation = document.getElementById('showLocation');
                if (showLocation) {
                    showLocation.addEventListener('change', (e) => {
                        updateSettings({ showLocation: e.target.checked });
                    });
                }
                
                const allowSearch = document.getElementById('allowSearch');
                if (allowSearch) {
                    allowSearch.addEventListener('change', (e) => {
                        updateSettings({ allowSearch: e.target.checked });
                    });
                }
                
                const showActivityStatus = document.getElementById('showActivityStatus');
                if (showActivityStatus) {
                    showActivityStatus.addEventListener('change', (e) => {
                        updateSettings({ showActivityStatus: e.target.checked });
                    });
                }
                
                const exportDataBtn = document.getElementById('exportDataBtn');
                if (exportDataBtn) {
                    exportDataBtn.addEventListener('click', () => {
                        alert('Data export functionality will be implemented with backend integration');
                    });
                }
                
                const deleteAccountBtn = document.getElementById('deleteAccountBtn');
                if (deleteAccountBtn) {
                    deleteAccountBtn.addEventListener('click', () => {
                        if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                            alert('Account deletion functionality will be implemented with backend integration');
                        }
                    });
                }
                
                // Account handlers
                const changePasswordBtn = document.getElementById('changePasswordBtn');
                if (changePasswordBtn) {
                    changePasswordBtn.addEventListener('click', handlePasswordChange);
                }
                
                const saveSecurityBtn = document.getElementById('saveSecurityBtn');
                if (saveSecurityBtn) {
                    saveSecurityBtn.addEventListener('click', handleSecuritySave);
                }
                
                const refreshSessionsBtn = document.getElementById('refreshSessionsBtn');
                if (refreshSessionsBtn) {
                    refreshSessionsBtn.addEventListener('click', loadActiveSessions);
                }
                
                // Portal handlers
                const showWelcomeMessage = document.getElementById('showWelcomeMessage');
                if (showWelcomeMessage) {
                    showWelcomeMessage.addEventListener('change', (e) => {
                        updateSettings({ showWelcomeMessage: e.target.checked });
                    });
                }
                
                const showQuickActions = document.getElementById('showQuickActions');
                if (showQuickActions) {
                    showQuickActions.addEventListener('change', (e) => {
                        updateSettings({ showQuickActions: e.target.checked });
                    });
                }
                
                const showRecentActivity = document.getElementById('showRecentActivity');
                if (showRecentActivity) {
                    showRecentActivity.addEventListener('change', (e) => {
                        updateSettings({ showRecentActivity: e.target.checked });
                    });
                }
                
                const sidebarCollapsed = document.getElementById('sidebarCollapsed');
                if (sidebarCollapsed) {
                    sidebarCollapsed.addEventListener('change', (e) => {
                        updateSettings({ sidebarCollapsed: e.target.checked });
                    });
                }
                
                const rememberSidebarState = document.getElementById('rememberSidebarState');
                if (rememberSidebarState) {
                    rememberSidebarState.addEventListener('change', (e) => {
                        updateSettings({ rememberSidebarState: e.target.checked });
                    });
                }
                
                const autoSave = document.getElementById('autoSave');
                if (autoSave) {
                    autoSave.addEventListener('change', (e) => {
                        updateSettings({ autoSave: e.target.checked });
                    });
                }
                
                const analyticsTracking = document.getElementById('analyticsTracking');
                if (analyticsTracking) {
                    analyticsTracking.addEventListener('change', (e) => {
                        updateSettings({ analyticsTracking: e.target.checked });
                    });
                }
            } catch (error) {
                console.error('Error initializing settings handlers:', error);
            }
        }
        
        // Time preview
        let timePreviewInterval = null;
        function startTimePreview() {
            function updateTimePreview() {
                const previewElement = document.getElementById('currentTimePreview');
                if (!previewElement) return;
                
                try {
                    const settings = getSettings();
                    const now = new Date();
                    
                    // Format date
                    let dateStr = '';
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const monthName = now.toLocaleString('en-US', { month: 'short' });
                    
                    switch(settings.dateFormat || 'MM/DD/YYYY') {
                        case 'MM/DD/YYYY': dateStr = `${month}/${day}/${year}`; break;
                        case 'DD/MM/YYYY': dateStr = `${day}/${month}/${year}`; break;
                        case 'YYYY-MM-DD': dateStr = `${year}-${month}-${day}`; break;
                        case 'DD MMM YYYY': dateStr = `${day} ${monthName} ${year}`; break;
                        default: dateStr = `${month}/${day}/${year}`;
                    }
                    
                    // Format time
                    let timeStr = '';
                    if ((settings.timeFormat || '12h') === '24h') {
                        timeStr = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                    } else {
                        timeStr = now.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit' });
                    }
                    
                    previewElement.textContent = `${dateStr} ${timeStr}`;
                } catch (error) {
                    console.error('Error updating time preview:', error);
                    previewElement.textContent = 'Error loading time';
                }
            }
            
            // Clear existing interval if any
            if (timePreviewInterval) {
                clearInterval(timePreviewInterval);
            }
            
            updateTimePreview();
            timePreviewInterval = setInterval(updateTimePreview, 1000);
        }
        
        // Load active sessions with test data
        function loadActiveSessions() {
            const container = document.getElementById('activeSessions');
            if (!container) {
                console.warn('[Settings] Active sessions container not found');
                // Try again after a short delay
                setTimeout(loadActiveSessions, 500);
                return;
            }
            
            console.log('[Settings] Loading active sessions...');
            
            // If container already has content (from HTML), we can update it or leave it
            // This function will refresh/update the sessions if called
            
            // Current session
            const currentSession = {
                device: navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Desktop',
                browser: getBrowserName(),
                location: 'Current Location',
                lastActive: 'Now',
                isCurrent: true,
                ip: '192.168.1.100'
            };
            
            // Test data: Additional active sessions
            const testSessions = [
                {
                    device: 'iPhone 14 Pro',
                    browser: 'Safari',
                    location: 'Riyadh, Saudi Arabia',
                    lastActive: '2 hours ago',
                    isCurrent: false,
                    ip: '185.123.45.67'
                },
                {
                    device: 'Windows PC',
                    browser: 'Chrome',
                    location: 'Dubai, UAE',
                    lastActive: '1 day ago',
                    isCurrent: false,
                    ip: '203.0.113.42'
                },
                {
                    device: 'iPad Pro',
                    browser: 'Safari',
                    location: 'Jeddah, Saudi Arabia',
                    lastActive: '3 days ago',
                    isCurrent: false,
                    ip: '198.51.100.10'
                }
            ];
            
            let html = '';
            
            // Current session
            html += `
                <div class="session-item" style="border-left: 3px solid var(--success-color);">
                    <div class="session-info">
                        <strong>${currentSession.device}</strong>
                        <small>${currentSession.browser} • ${currentSession.location}</small>
                        <small style="display: block; margin-top: 0.25rem; color: var(--text-secondary);">
                            Last active: ${currentSession.lastActive} • IP: ${currentSession.ip}
                        </small>
                    </div>
                    <span class="badge" style="background: var(--success-color); color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">Current Session</span>
                </div>
            `;
            
            // Other sessions
            testSessions.forEach((session, index) => {
                html += `
                    <div class="session-item" style="opacity: 0.85;">
                        <div class="session-info">
                            <strong>${session.device}</strong>
                            <small>${session.browser} • ${session.location}</small>
                            <small style="display: block; margin-top: 0.25rem; color: var(--text-secondary);">
                                Last active: ${session.lastActive} • IP: ${session.ip}
                            </small>
                        </div>
                        <button onclick="revokeSession(${index})" class="btn btn-sm" style="padding: 0.25rem 0.75rem; font-size: 0.75rem; background: var(--color-danger, #dc3545); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Revoke
                        </button>
                    </div>
                `;
            });
            
            if (html) {
                container.innerHTML = html;
                console.log('[Settings] Active sessions loaded:', testSessions.length + 1, 'sessions');
            } else {
                console.error('[Settings] No HTML generated for sessions');
                container.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                        <p>Error loading sessions. Please refresh the page.</p>
                        <button onclick="loadActiveSessions()" class="btn btn-primary" style="margin-top: 1rem;">Retry</button>
                    </div>
                `;
            }
        }
        
        // Make loadActiveSessions available globally for retry
        window.loadActiveSessions = loadActiveSessions;
        
        // Revoke session function
        function revokeSession(index) {
            if (confirm('Are you sure you want to revoke this session? The user will need to log in again from this device.')) {
                // Remove session from display
                const container = document.getElementById('activeSessions');
                if (container) {
                    const sessions = container.querySelectorAll('.session-item');
                    if (sessions[index + 1]) { // +1 because first is current session
                        sessions[index + 1].style.opacity = '0.5';
                        sessions[index + 1].innerHTML = `
                            <div class="session-info" style="flex: 1;">
                                <small style="color: var(--text-secondary); font-style: italic;">Session revoked</small>
                            </div>
                        `;
                    }
                }
                console.log('Session revoked:', index);
            }
        }
        
        // Make revokeSession available globally
        window.revokeSession = revokeSession;
        
        function getBrowserName() {
            const ua = navigator.userAgent;
            if (ua.includes('Chrome')) return 'Chrome';
            if (ua.includes('Firefox')) return 'Firefox';
            if (ua.includes('Safari')) return 'Safari';
            if (ua.includes('Edge')) return 'Edge';
            return 'Unknown';
        }
        
        async function handlePasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Please fill in all password fields');
                return;
            }
            
            if (newPassword.length < 8) {
                alert('New password must be at least 8 characters long');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }
            
            // TODO: Implement password change API call
            alert('Password change functionality will be implemented with backend integration');
            
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        async function handleSecuritySave() {
            const twoFactorAuth = document.getElementById('twoFactorAuth').checked;
            updateSettings({ twoFactorAuth });
        }
    </script>
</body>
</html>
